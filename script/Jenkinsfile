pipeline {
    agent any
    environment {
        // 이미지 이름과 버전(빌드 번호 활용)
        IMAGE_NAME = "my-spring-app"
        VERSION = "1.0.${BUILD_NUMBER}"
    }
    stages {
        stage('Checkout') {
            steps {
                // 소스코드 체크아웃 (SCM 설정에 따라 자동 구성)
                checkout scm
            }
        }
        stage('Build with Maven') {
            steps {
                // Maven Wrapper를 사용해 빌드 (테스트 건너뛰기)
                sh 'chmod +x mvnw'
                sh './mvnw clean package -DskipTests'
            }
        }
        stage('Archive Artifact') {
            steps {
                // target 폴더 내의 *.jar 파일 아카이브 (빌드 결과 확인용)
                archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
            }
        }
        stage('Build Docker Image') {
            steps {
                // Dockerfile이 프로젝트 루트에 존재하며, 빌드된 jar 파일을 이용해 이미지를 빌드
                sh "docker build -t ${IMAGE_NAME}:${VERSION} ."
            }
        }
        stage('Push Docker Image') {
            steps {
                // (옵션) Docker Registry에 푸시하는 단계
                // 예: Docker Hub, Nexus, Harbor 등
                // sh "docker push ${IMAGE_NAME}:${VERSION}"
                echo "Docker Image ${IMAGE_NAME}:${VERSION} built successfully."
            }
        }
    }
    post {
        always {
            // 빌드 후 작업 공간 정리
            cleanWs()
        }
    }
}
